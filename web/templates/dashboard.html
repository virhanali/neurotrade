{{define "dashboard"}}
<!DOCTYPE html>
<html lang="en" class="light">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroTrade | AI Quantitative System</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="apple-touch-icon" href="/static/images/favicon.svg">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config for Dark Mode & Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark surface
                            900: '#0f172a',
                            950: '#020617', // Custom dark bg
                        }
                    }
                }
            }
        }
    </script>

    <!-- Dark Mode Logic -->
    <script>
        // Check local storage or system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        // Sidebar Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (window.innerWidth < 1024) {
                // Mobile
                const isClosed = sidebar.classList.contains('-translate-x-full');
                if (isClosed) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            } else {
                // Desktop
                if (sidebar.classList.contains('w-64')) {
                    sidebar.classList.replace('w-64', 'w-20');
                    document.body.classList.add('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', 'true');
                } else {
                    sidebar.classList.replace('w-20', 'w-64');
                    document.body.classList.remove('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
            }
        }

        // Init Sidebar & Routing
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Sidebar Init
                const sidebar = document.getElementById('sidebar');
                if (sidebar && window.innerWidth >= 1024 && localStorage.getItem('sidebarCollapsed') === 'true') {
                    sidebar.classList.replace('w-64', 'w-20');
                    document.body.classList.add('sidebar-collapsed');
                }
            } catch (e) {
                console.error('Sidebar init error:', e);
            }

            // Routing Init - always run even if sidebar fails
            const path = window.location.pathname;
            let activeTab = 'dashboard';

            // Check path /dashboard/tabName
            const match = path.match(/\/dashboard\/(.+)/);
            if (match && match[1]) {
                activeTab = match[1];
            } else if (window.location.hash) {
                // Legacy hash support
                activeTab = window.location.hash.replace('#', '');
            }

            // Verify tab exists, default to dashboard if not
            if (!document.getElementById('tab-' + activeTab)) {
                activeTab = 'dashboard';
            }

            console.log('[Router] Switching to tab:', activeTab);
            switchTab(activeTab, null);
        });

        // Handle Browser Back/Forward
        window.onpopstate = function (event) {
            const path = window.location.pathname;
            let tab = 'dashboard';
            const match = path.match(/\/dashboard\/(.+)/);
            if (match && match[1]) {
                tab = match[1];
            }
            switchTab(tab, null);
        };

        function switchTab(tabName, event) {
            if (event) event.preventDefault();

            // Hide all tabs
            ['tab-dashboard', 'tab-brain-health', 'tab-live', 'tab-history'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Show selected tab
            const target = document.getElementById('tab-' + tabName);
            if (target) target.classList.remove('hidden');

            // Update Nav Styles
            const activeClass = ['bg-slate-100', 'dark:bg-slate-800', 'text-emerald-600', 'dark:text-emerald-400'];
            const inactiveClass = ['text-slate-600', 'dark:text-slate-400', 'hover:bg-slate-50', 'dark:hover:bg-slate-800'];

            // Reset all navs
            ['dashboard', 'brain', 'live', 'history'].forEach(id => {
                const el = document.getElementById('nav-' + id);
                if (el) {
                    el.classList.remove(...activeClass);
                    el.classList.add(...inactiveClass);
                }
            });

            // Activate selected nav
            let navId = tabName;
            if (tabName === 'brain-health') navId = 'brain';

            const activeNav = document.getElementById('nav-' + navId);
            if (activeNav) {
                activeNav.classList.remove(...inactiveClass);
                activeNav.classList.add(...activeClass);
            }

            // Update Header & URL
            const headers = {
                'dashboard': { title: 'Market Overview', subtitle: 'Aggressive Scalping • M15 Timeframe' },
                'brain-health': { title: 'Brain Health Center', subtitle: 'AI Neural Status & Feature Analysis' },
                'live': { title: 'Active Portfolio', subtitle: 'Real-time Position Tracking & PnL' },
                'history': { title: 'Trade Log', subtitle: 'Historical Performance & Analytics' }
            };

            const info = headers[tabName] || headers['dashboard'];
            const titleEl = document.getElementById('page-title');
            const subEl = document.getElementById('page-subtitle');

            if (titleEl) titleEl.innerText = info.title;
            if (subEl) subEl.innerText = info.subtitle;

            // Update URL (Push State)
            let newPath = '/dashboard/' + tabName;

            // Clean URL for dashboard
            if (tabName === 'dashboard') {
                newPath = '/dashboard';
            }

            if (window.location.pathname !== newPath) {
                history.pushState({ tab: tabName }, '', newPath);
            }

            // Trigger data load if brain health
            if (tabName === 'brain-health') {
                loadBrainStats();
            }

            // Trigger HTMX for tables to ensure fresh data
            if (tabName === 'live') {
                const el = document.getElementById('live-positions-tbody');
                if (el) {
                    htmx.ajax('GET', '/api/user/positions/html', { target: el, swap: 'innerHTML' });
                    // Set up polling for live tab
                    if (!window.livePollingInterval) {
                        window.livePollingInterval = setInterval(() => {
                            htmx.ajax('GET', '/api/user/positions/html', { target: el, swap: 'innerHTML' });
                        }, 3000);
                    }
                }
            } else {
                // Clear live polling when leaving live tab
                if (window.livePollingInterval) {
                    clearInterval(window.livePollingInterval);
                    window.livePollingInterval = null;
                }
            }
            if (tabName === 'history') {
                const el = document.getElementById('history-positions-tbody');
                if (el) {
                    htmx.ajax('GET', '/api/user/history/html', { target: el, swap: 'innerHTML' });
                }
            }
        }

        async function loadBrainStats() {
            try {
                const response = await fetch('/api/admin/ml/brain-health');
                const data = await response.json();
                renderBrainStats(data);
            } catch (error) {
                console.error('Failed to load brain stats:', error);
            }
        }

        function renderBrainStats(data) {
            // Updated via JS to avoid template complexity
            document.getElementById('brain-samples').innerText = data.samples || 0;
            document.getElementById('brain-progress').style.width = (data.progress_percent || 0) + '%';

            // Status display (only 'active' or 'learning' from Python backend)
            const statusEl = document.getElementById('brain-status');
            if (data.status === 'active') {
                statusEl.innerText = 'Active';
                statusEl.className = 'px-2 py-0.5 rounded-full text-xs font-bold bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400';
            } else {
                statusEl.innerText = 'Learning';
                statusEl.className = 'px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400';
            }

            // Market Regime - with user-friendly labels
            const regimeEl = document.getElementById('regime-type');
            const regimeConfEl = document.getElementById('regime-conf');

            if (data.market_regime && data.market_regime.type) {
                const regimeMap = {
                    'WAITING_DATA': 'Waiting for Data',
                    'UNKNOWN': 'Analyzing...',
                    'TRENDING': 'Trending',
                    'RANGING': 'Ranging',
                    'VOLATILE': 'Volatile',
                    'QUIET': 'Quiet',
                    'ERROR': 'Error'
                };
                regimeEl.innerText = regimeMap[data.market_regime.type] || data.market_regime.type;
                regimeConfEl.innerText = (data.market_regime.confidence || 0) + '%';
            } else {
                regimeEl.innerText = 'Analyzing...';
                regimeConfEl.innerText = '0%';
            }

            // Render Whale Stats
            if (data.feature_importance && (data.feature_importance.funding_rate > 0 || data.feature_importance.ls_ratio > 0)) {
                const gatheringMsg = document.getElementById('whale-gathering-msg');
                const statsContainer = document.getElementById('whale-stats-container');
                if (gatheringMsg) gatheringMsg.classList.add('hidden');
                if (statsContainer) statsContainer.classList.remove('hidden');

                // Scaling importance for visualization (e.g. max 20% importance fills bar)
                const fundingImp = Math.min((data.feature_importance.funding_rate || 0) * 500, 100);
                document.getElementById('funding-bar').style.width = fundingImp + '%';
                // Display raw percentage
                document.getElementById('funding-val').innerText = ((data.feature_importance.funding_rate || 0) * 100).toFixed(1) + '%';

                const lsImp = Math.min((data.feature_importance.ls_ratio || 0) * 500, 100);
                document.getElementById('ls-bar').style.width = lsImp + '%';
                document.getElementById('ls-val').innerText = ((data.feature_importance.ls_ratio || 0) * 100).toFixed(1) + '%';
            } else {
                const gatheringMsg = document.getElementById('whale-gathering-msg');
                const statsContainer = document.getElementById('whale-stats-container');
                if (gatheringMsg) gatheringMsg.classList.remove('hidden');
                if (statsContainer) statsContainer.classList.add('hidden');
            }

            // Update Feature Chart - show empty state if no data
            const chartContainer = document.getElementById('featureChartContainer');
            const emptyState = document.getElementById('featureChartEmpty');

            if (window.featureChart && typeof window.featureChart.destroy === 'function') {
                window.featureChart.destroy();
                window.featureChart = null;
            }

            const ctx = document.getElementById('featureChart');
            const hasFeatureData = data.feature_importance && Object.keys(data.feature_importance).length > 0 &&
                Object.values(data.feature_importance).some(v => v > 0);

            if (ctx && hasFeatureData) {
                if (chartContainer) chartContainer.classList.remove('hidden');
                if (emptyState) emptyState.classList.add('hidden');

                window.featureChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.feature_importance),
                        datasets: [{
                            label: 'Importance',
                            data: Object.values(data.feature_importance),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            } else {
                if (chartContainer) chartContainer.classList.add('hidden');
                if (emptyState) emptyState.classList.remove('hidden');
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* HTMX Indicator - Skeleton styles */
        .htmx-indicator {
            display: none;
            opacity: 0;
            transition: opacity 200ms ease-in;
        }

        .htmx-request .htmx-indicator {
            display: inline;
            opacity: 1;
        }

        .htmx-request.htmx-indicator {
            display: inline;
            opacity: 1;
        }

        /* Skeleton Animation */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
        }

        /* Sidebar Collapse */
        body.sidebar-collapsed .group span:not(.relative) {
            display: none;
        }

        body.sidebar-collapsed .sidebar-brand-text {
            display: none;
        }

        body.sidebar-collapsed .sidebar-brand-icon {
            margin-right: 0;
        }

        body.sidebar-collapsed nav a {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        body.sidebar-collapsed nav i {
            margin-right: 0;
            font-size: 1.5rem;
        }

        /* Mobile Overlay */
        #sidebar-overlay {
            transition: opacity 0.3s ease;
        }

        /* PnL Flash Animation */
        @keyframes flash-green {
            0% {
                background-color: rgba(16, 185, 129, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes flash-red {
            0% {
                background-color: rgba(244, 63, 94, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        .flash-profit {
            animation: flash-green 0.6s ease-out;
        }

        .flash-loss {
            animation: flash-red 0.6s ease-out;
        }

        .pnl-cell,
        .price-cell {
            transition: all 0.2s ease;
            border-radius: 0.375rem;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-200">

    <!-- Mobile Header -->
    <div
        class="lg:hidden flex items-center justify-between p-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
            <i class="ri-brain-line text-emerald-500 text-xl"></i>
            <span class="font-bold text-lg">NeuroTrade</span>
        </div>
        <button onclick="toggleSidebar()"
            class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
            <i class="ri-menu-line text-xl"></i>
        </button>
    </div>

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()"
            class="fixed inset-0 bg-slate-900/50 z-40 hidden lg:hidden backdrop-blur-sm"></div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-auto transition-all duration-300 flex flex-col">

            <!-- Desktop Collapse Button -->
            <button onclick="toggleSidebar()"
                class="hidden lg:flex absolute -right-3 top-6 w-6 h-6 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full items-center justify-center text-slate-500 hover:text-emerald-500 shadow-sm z-50 transition-transform duration-300">
                <i class="ri-arrow-left-s-line transformed-icon"></i>
            </button>

            <!-- Brand -->
            <div
                class="h-16 flex items-center px-6 border-b border-slate-100 dark:border-slate-800 overflow-hidden whitespace-nowrap">
                <i class="ri-brain-fill text-emerald-500 text-2xl mr-3 sidebar-brand-icon flex-shrink-0"></i>
                <span class="font-bold text-xl tracking-tight sidebar-brand-text">NeuroTrade</span>
            </div>

            <!-- Nav Links -->
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto overflow-x-hidden">
                <a href="#" onclick="switchTab('dashboard', event)" id="nav-dashboard"
                    class="flex items-center px-3 py-2.5 bg-slate-100 dark:bg-slate-800 text-emerald-600 dark:text-emerald-400 font-medium rounded-lg group transition-colors whitespace-nowrap">
                    <i class="ri-dashboard-3-line mr-3 text-lg flex-shrink-0"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="switchTab('brain-health', event)" id="nav-brain"
                    class="flex items-center px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-100 font-medium rounded-lg transition-colors group whitespace-nowrap">
                    <i class="ri-brain-line mr-3 text-lg group-hover:text-emerald-500 flex-shrink-0"></i>
                    <span>Brain Health</span>
                </a>
                <a href="#" onclick="switchTab('live', event)" id="nav-live"
                    class="flex items-center px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-100 font-medium rounded-lg transition-colors group whitespace-nowrap">
                    <i class="ri-pulse-line mr-3 text-lg group-hover:text-emerald-500 flex-shrink-0"></i>
                    <span>Live Positions</span>
                </a>
                <a href="#" onclick="switchTab('history', event)" id="nav-history"
                    class="flex items-center px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-100 font-medium rounded-lg transition-colors group whitespace-nowrap">
                    <i class="ri-history-line mr-3 text-lg group-hover:text-emerald-500 flex-shrink-0"></i>
                    <span>Trade History</span>
                </a>
            </nav>

            <!-- User Profile & Theme -->
            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <div class="flex items-center justify-between mb-4 sidebar-brand-text">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Appearance</span>
                    <button onclick="toggleTheme()"
                        class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 transition-colors">
                        <i class="ri-sun-line dark:hidden"></i>
                        <i class="ri-moon-line hidden dark:inline"></i>
                    </button>
                </div>
                <div
                    class="flex items-center p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 overflow-hidden whitespace-nowrap">
                    <div
                        class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900 flex items-center justify-center text-emerald-600 dark:text-emerald-400 font-bold text-sm flex-shrink-0">
                        {{if .User.Username}}{{slice .User.Username 0 1}}{{else}}A{{end}}
                    </div>
                    <div class="ml-3 overflow-hidden flex-1 group">
                        <p class="text-sm font-medium text-slate-900 dark:text-white truncate group-span">
                            {{.User.Username}}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 capitalize group-span">{{.User.Role}}</p>
                    </div>
                </div>
                <!-- Logout Button -->
                <form id="logout-form" action="/api/auth/logout" method="POST" class="hidden"></form>
                <button
                    onclick="showConfirmModal('Logout', 'Are you sure you want to end your session?', () => document.getElementById('logout-form').submit(), 'logout')"
                    class="mt-3 w-full flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-rose-600 dark:hover:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors whitespace-nowrap">
                    <i class="ri-logout-box-r-line text-lg flex-shrink-0"></i>
                    <span class="sidebar-brand-text">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto h-full relative" id="main-content">
            <!-- Toast Container -->
            <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

                <!-- Page Header & Actions -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                    <div>
                        <h1 id="page-title" class="text-2xl font-bold text-slate-900 dark:text-white">Market Overview
                        </h1>
                        <p id="page-subtitle" class="text-sm text-slate-500 dark:text-slate-400 mt-1">Aggressive
                            Scalping • M15 Timeframe
                        </p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div id="tab-dashboard">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">

                        <!-- Balance Card -->
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden group hover:border-emerald-500/30 transition-colors">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Equity</p>
                                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1">${{printf "%.2f"
                                        .User.PaperBalance}}</h3>
                                    {{if gt .TodayPnLPercent 0.0}}
                                    <div
                                        class="flex items-center mt-1 text-xs text-emerald-600 dark:text-emerald-400 font-medium">
                                        <i class="ri-arrow-up-line mr-1"></i>
                                        <span>+{{printf "%.2f" .TodayPnLPercent}}% Today</span>
                                    </div>
                                    {{else if lt .TodayPnLPercent 0.0}}
                                    <div
                                        class="flex items-center mt-1 text-xs text-rose-600 dark:text-rose-400 font-medium">
                                        <i class="ri-arrow-down-line mr-1"></i>
                                        <span>{{printf "%.2f" .TodayPnLPercent}}% Today</span>
                                    </div>
                                    {{else}}
                                    <div
                                        class="flex items-center mt-1 text-xs text-slate-500 dark:text-slate-400 font-medium">
                                        <i class="ri-subtract-line mr-1"></i>
                                        <span>0.00% Today</span>
                                    </div>
                                    {{end}}
                                </div>
                                <div
                                    class="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400 group-hover:text-emerald-500 transition-colors">
                                    <i class="ri-wallet-3-line text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- PnL Card -->
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total PnL</p>
                                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="total-pnl">
                                        {{if .Stats}}{{if index .Stats "total_pnl"}}${{printf "%.2f" (index .Stats
                                        "total_pnl")}}{{else}}$0.00{{end}}{{else}}$0.00{{end}}</h3>
                                </div>
                                <div
                                    class="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400">
                                    <i class="ri-line-chart-line text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Win Rate Card -->
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Win Rate</p>
                                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1">{{if
                                        .Stats}}{{printf
                                        "%.1f" .Stats.WinRate}}%{{else}}--%{{end}}</h3>
                                </div>
                                <div
                                    class="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400">
                                    <i class="ri-trophy-line text-xl"></i>
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- Main Content Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                        <!-- Left Column: Activity & Chart (2/3) -->
                        <div class="lg:col-span-2 space-y-8">

                            <!-- Empty State / Chart Placeholder -->
                            <div
                                class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Performance
                                        Analytics
                                    </h3>
                                    <select
                                        class="bg-slate-50 dark:bg-slate-800 border-none text-xs rounded-md text-slate-600 dark:text-slate-300 py-1 pl-2 pr-6">
                                        <option>Last 24 Hours</option>
                                        <option>Last 7 Days</option>
                                    </select>
                                </div>
                                <div id="chart-container" class="h-64 relative w-full">
                                    <!-- Canvas for Chart.js -->
                                    <canvas id="performanceChart"></canvas>
                                </div>

                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const ctx = document.getElementById('performanceChart').getContext('2d');

                                        // Fetch PnL History
                                        fetch('/api/user/analytics/pnl')
                                            .then(response => response.json())
                                            .then(res => {
                                                if (res.data && res.data.labels && res.data.labels.length > 0) {
                                                    const isDark = document.documentElement.classList.contains('dark');
                                                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                                                    const textColor = isDark ? '#94a3b8' : '#64748b';

                                                    new Chart(ctx, {
                                                        type: 'line',
                                                        data: {
                                                            labels: res.data.labels,
                                                            datasets: [{
                                                                label: 'Cumulative PnL',
                                                                data: res.data.data,
                                                                borderColor: '#10b981', // Emerald 500
                                                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                                                borderWidth: 2,
                                                                tension: 0.4, // Smooth curve
                                                                fill: true,
                                                                pointRadius: 3,
                                                                pointHoverRadius: 5,
                                                                pointBackgroundColor: '#10b981'
                                                            }]
                                                        },
                                                        options: {
                                                            responsive: true,
                                                            maintainAspectRatio: false,
                                                            plugins: {
                                                                legend: { display: false },
                                                                tooltip: {
                                                                    mode: 'index',
                                                                    intersect: false,
                                                                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                                                                    titleColor: isDark ? '#ffffff' : '#0f172a',
                                                                    bodyColor: isDark ? '#cbd5e1' : '#334155',
                                                                    borderColor: isDark ? '#334155' : '#e2e8f0',
                                                                    borderWidth: 1,
                                                                    callbacks: {
                                                                        label: function (context) {
                                                                            return ' PnL: $' + context.parsed.y.toFixed(2);
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            scales: {
                                                                x: {
                                                                    display: false, // Hide numeric labels for cleaner look
                                                                    grid: { display: false }
                                                                },
                                                                y: {
                                                                    grid: { color: gridColor },
                                                                    ticks: {
                                                                        color: textColor,
                                                                        callback: function (value) { return '$' + value; },
                                                                        font: { family: "'Inter', sans-serif", size: 10 }
                                                                    },
                                                                    border: { display: false }
                                                                }
                                                            },
                                                            interaction: {
                                                                mode: 'nearest',
                                                                axis: 'x',
                                                                intersect: false
                                                            }
                                                        }
                                                    });
                                                } else {
                                                    // Show Empty State if no data
                                                    document.getElementById('chart-container').innerHTML = `
                                                    <div class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 bg-slate-50/50 dark:bg-slate-800/20 rounded-lg border border-dashed border-slate-200 dark:border-slate-700">
                                                        <i class="ri-bar-chart-groupped-line text-4xl mb-2 opacity-50"></i>
                                                        <p class="text-sm font-medium">Chart data will appear after first close trade</p>
                                                    </div>
                                                `;
                                                }
                                            })
                                            .catch(err => console.error("Failed to load chart data:", err));
                                    });
                                </script>
                            </div>

                            <!-- Active Positions Table -->
                            <div
                                class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                                <div
                                    class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Active Positions
                                    </h3>
                                    <span
                                        class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-xs px-2 py-1 rounded-full font-medium">Live</span>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-left">
                                        <thead
                                            class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800">
                                            <tr>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                    Symbol</th>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                    Side</th>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                    Entry</th>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                    Current</th>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                    TP/SL</th>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                    PnL</th>
                                                <th
                                                    class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">
                                                    Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800"
                                            hx-get="/api/user/positions/html" hx-trigger="load, every 5s">
                                            <!-- Loading State inside Table -->
                                            <tr>
                                                <td colspan="7" class="p-4 text-center text-sm text-slate-400">
                                                    <div class="flex items-center justify-center gap-2">
                                                        <i class="ri-loader-4-line animate-spin"></i> Loading
                                                        positions...
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Signals & Feed (1/3) -->
                        <div class="space-y-8">

                            <!-- Latest Signals -->
                            <div
                                class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col max-h-[600px]">
                                <div
                                    class="px-5 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-900 z-10">
                                    <div class="flex items-center gap-3">
                                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">AI Signals</h3>
                                        <span class="flex h-2 w-2 relative">
                                            <span
                                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                            <span
                                                class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                        </span>
                                    </div>
                                    <select id="signalFilter" onchange="filterSignals(this.value)"
                                        class="bg-slate-50 dark:bg-slate-800 border-none text-[10px] font-medium uppercase tracking-wide rounded text-slate-600 dark:text-slate-400 py-1 pl-2 pr-6 focus:ring-0 cursor-pointer h-7">
                                        <option value="ALL">All</option>
                                        <option value="RUNNING">Running</option>
                                        <option value="WIN">Wins</option>
                                        <option value="LOSS">Losses</option>
                                    </select>
                                </div>

                                <!-- CONTENT AREA -->
                                <div id="scan-results"
                                    class="overflow-y-auto p-2 space-y-2 min-h-[400px] custom-scrollbar"
                                    hx-get="/api/admin/market-scan/results" hx-trigger="load, every 10s"
                                    hx-swap="innerHTML">

                                    <!-- SKELETON -->
                                    <div
                                        class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between mb-2">
                                            <div class="skeleton h-4 w-20 rounded"></div>
                                            <div class="skeleton h-4 w-12 rounded"></div>
                                        </div>
                                        <div class="skeleton h-3 w-full rounded"></div>
                                    </div>
                                    <div
                                        class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between mb-2">
                                            <div class="skeleton h-4 w-20 rounded"></div>
                                            <div class="skeleton h-4 w-12 rounded"></div>
                                        </div>
                                        <div class="skeleton h-3 w-full rounded"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- System Status Small -->
                            <div
                                class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                                <h4
                                    class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">
                                    System Health</h4>
                                <div hx-get="/api/admin/system/health" hx-trigger="load, every 30s">
                                    <div class="skeleton h-4 w-full rounded"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div> <!-- End tab-dashboard -->

            <!-- Brain Health Tab -->
            <div id="tab-brain-health" class="hidden space-y-6">
                <!-- Training Progress -->
                <div
                    class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                        <i class="ri-brain-line mr-2 text-emerald-500"></i> ML Training Progress
                    </h3>
                    <div class="flex items-center justify-between mb-2 text-sm text-slate-500 dark:text-slate-400">
                        <span>Progress: <span id="brain-samples"
                                class="font-bold text-slate-900 dark:text-white">0</span> / 50 Trades</span>
                        <span id="brain-status"
                            class="px-2 py-0.5 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs font-bold">Learning</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4 overflow-hidden relative">
                        <div id="brain-progress"
                            class="bg-emerald-500 h-4 rounded-full transition-all duration-1000 relative overflow-hidden"
                            style="width: 0%">
                            <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">ML model requires 50 closed trades to activate self-learning
                        capabilities. Currently collecting high-quality data.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                    <!-- Feature Importance -->
                    <div
                        class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm h-fit">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Feature Importance</h3>
                            <span
                                class="text-xs text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full">ML
                                Insights</span>
                        </div>

                        <!-- Chart Container -->
                        <div id="featureChartContainer" class="hidden">
                            <canvas id="featureChart" height="200"></canvas>
                            <p class="text-xs text-slate-400 mt-3 text-center">Shows which market indicators have the
                                most impact on AI predictions</p>
                        </div>

                        <!-- Empty State -->
                        <div id="featureChartEmpty" class="py-8">
                            <div class="flex flex-col items-center justify-center text-center">
                                <div
                                    class="w-14 h-14 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4">
                                    <i class="ri-bar-chart-grouped-line text-2xl text-slate-400"></i>
                                </div>
                                <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Not Enough Data
                                    Yet</p>
                                <p class="text-xs text-slate-400 max-w-xs">Feature importance analysis will be available
                                    after the ML model completes training with sufficient trade data.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Whale Radar -->
                    <div
                        class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Whale Radar & Market
                            Regime</h3>

                        <div
                            class="flex items-center justify-center p-6 bg-slate-50 dark:bg-slate-800/50 rounded-lg mb-4 border border-slate-100 dark:border-slate-700">
                            <div class="text-center">
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Current Regime
                                </p>
                                <h2 id="regime-type" class="text-3xl font-black text-slate-900 dark:text-white">
                                    DETECTING...</h2>
                                <p class="text-emerald-500 font-medium mt-1 text-sm">Confidence: <span
                                        id="regime-conf">0%</span></p>
                            </div>
                        </div>

                        <!-- Placeholder for Future Whale Correlation Data -->
                        <!-- Whale Correlation Section -->
                        <div id="whale-gathering-msg" class="mt-6 text-center">
                            <div
                                class="inline-flex items-center px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-xs text-slate-500 font-medium">
                                <i class="ri-loader-4-line animate-spin mr-2"></i>
                                Gathering Whale Data (Requires 50+ Trades)
                            </div>
                        </div>

                        <div id="whale-stats-container" class="hidden space-y-4 mt-6">
                            <div
                                class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center text-sm mb-1">
                                    <span class="text-slate-500 text-xs uppercase font-bold">Funding Rate
                                        Relevance</span>
                                    <span id="funding-val"
                                        class="text-slate-900 dark:text-white font-mono font-bold">0%</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-1.5">
                                    <div id="funding-bar"
                                        class="bg-rose-500 h-1.5 rounded-full transition-all duration-1000"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                            <div
                                class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center text-sm mb-1">
                                    <span class="text-slate-500 text-xs uppercase font-bold">L/S Ratio Impact</span>
                                    <span id="ls-val"
                                        class="text-slate-900 dark:text-white font-mono font-bold">0%</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-1.5">
                                    <div id="ls-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-1000"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Positions Tab -->
                <div id="tab-live" class="hidden">
                    <div
                        class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div
                            class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Active Positions</h3>
                            <span
                                class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400">
                                Live & Updating
                            </span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left">
                                <thead class="bg-slate-50 dark:bg-slate-800/50">
                                    <tr>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Time</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Symbol</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Side</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Entry</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Current</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            TP/SL</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            PnL</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="live-positions-tbody" class="divide-y divide-slate-100 dark:divide-slate-800"
                                    hx-get="/api/user/positions/html" hx-trigger="load, every 5s" hx-swap="innerHTML">
                                    <tr>
                                        <td colspan="8" class="p-12 text-center text-sm text-slate-400">
                                            <div class="flex flex-col items-center justify-center gap-3">
                                                <i class="ri-loader-4-line animate-spin text-2xl text-emerald-500"></i>
                                                <span class="animate-pulse font-medium">Syncing Active
                                                    Positions...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trade History Tab -->
                <div id="tab-history" class="hidden">
                    <div
                        class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <!-- Controls / Filter -->
                        <div
                            class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                            <div class="flex gap-2">
                                <button
                                    class="px-3 py-1.5 text-xs font-medium bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md text-slate-900 dark:text-white shadow-sm">All
                                    Trades</button>
                                <button
                                    class="px-3 py-1.5 text-xs font-medium text-slate-500 hover:text-emerald-500 transition-colors">Winners</button>
                                <button
                                    class="px-3 py-1.5 text-xs font-medium text-slate-500 hover:text-rose-500 transition-colors">Losers</button>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                                    <i class="ri-filter-3-line"></i>
                                </button>
                                <button
                                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                                    <tr>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Date</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Symbol</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Side</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Size</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Entry</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Exit</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            PnL</th>
                                        <th
                                            class="py-3 px-6 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">
                                            Status</th>
                                    </tr>
                                </thead>
                                <tbody id="history-positions-tbody"
                                    class="divide-y divide-slate-100 dark:divide-slate-800"
                                    hx-get="/api/user/history/html" hx-trigger="load" hx-swap="innerHTML">
                                    <!-- Empty State -->
                                    <tr>
                                        <td colspan="8" class="p-12 text-center">
                                            <div
                                                class="flex flex-col items-center justify-center text-slate-400 dark:text-slate-500">
                                                <div
                                                    class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 text-emerald-500/50">
                                                    <i class="ri-file-list-3-line text-3xl"></i>
                                                </div>
                                                <p class="text-base font-medium text-slate-900 dark:text-white mb-2">No
                                                    Trade History Yet</p>
                                                <p class="text-sm max-w-sm mx-auto mb-6 text-slate-500">Completed trades
                                                    will appear here automatically after AI closes a position.</p>
                                                <button onclick="switchTab('dashboard', event)"
                                                    class="text-emerald-500 hover:text-emerald-400 text-sm font-medium flex items-center gap-1 transition-colors">
                                                    Go to Dashboard <i class="ri-arrow-right-line"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="hideConfirmModal()"></div>
        <!-- Modal -->
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 w-full max-w-sm transform transition-all scale-95 opacity-0"
                id="confirm-modal-content">
                <div class="p-6">
                    <!-- Icon -->
                    <div id="confirm-modal-icon"
                        class="w-12 h-12 mx-auto mb-4 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                        <i class="ri-question-line text-2xl text-emerald-600 dark:text-emerald-400"></i>
                    </div>
                    <!-- Title -->
                    <h3 id="confirm-modal-title"
                        class="text-lg font-semibold text-slate-900 dark:text-white text-center mb-2">
                        Confirm Action
                    </h3>
                    <!-- Message -->
                    <p id="confirm-modal-message" class="text-sm text-slate-500 dark:text-slate-400 text-center">
                        Are you sure you want to proceed?
                    </p>
                </div>
                <!-- Actions -->
                <div class="flex border-t border-slate-200 dark:border-slate-700">
                    <button onclick="hideConfirmModal()"
                        class="flex-1 py-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors rounded-bl-2xl">
                        Cancel
                    </button>
                    <button id="confirm-modal-btn" onclick="confirmModalAction()"
                        class="flex-1 py-3 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 transition-colors rounded-br-2xl">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Confirmation Modal State
        let confirmCallback = null;

        function showConfirmModal(title, message, callback, type = 'default') {
            confirmCallback = callback;

            // Set content
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;

            // Set icon and button color based on type
            const iconEl = document.getElementById('confirm-modal-icon');
            const btnEl = document.getElementById('confirm-modal-btn');

            if (type === 'logout' || type === 'danger') {
                iconEl.className = 'w-12 h-12 mx-auto mb-4 rounded-full bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center';
                iconEl.innerHTML = '<i class="ri-logout-box-r-line text-2xl text-rose-600 dark:text-rose-400"></i>';
                btnEl.className = 'flex-1 py-3 text-sm font-semibold text-white bg-rose-600 hover:bg-rose-700 transition-colors rounded-br-2xl';
                btnEl.textContent = type === 'logout' ? 'Logout' : 'Confirm';
            } else {
                iconEl.className = 'w-12 h-12 mx-auto mb-4 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center';
                iconEl.innerHTML = '<i class="ri-radar-line text-2xl text-emerald-600 dark:text-emerald-400"></i>';
                btnEl.className = 'flex-1 py-3 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 transition-colors rounded-br-2xl';
                btnEl.textContent = 'Confirm';
            }

            // Show modal
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.classList.remove('hidden');

            // Animate in
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            });
        }

        function hideConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
                confirmCallback = null;
            }, 150);
        }

        function confirmModalAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmModal();
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let bgClass = type === 'success' ? 'bg-slate-900 dark:bg-slate-800 text-white' : 'bg-rose-600 text-white';
            let icon = type === 'success' ? '<i class="ri-checkbox-circle-fill text-emerald-400 text-lg"></i>' : '<i class="ri-error-warning-fill text-white text-lg"></i>';

            toast.className = `flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-2 opacity-0 ${bgClass}`;
            toast.innerHTML = `
                ${icon}
                <span class="text-sm font-medium">${message}</span>
            `;

            container.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Price & PnL Flash Tracking
        const pnlCache = new Map();
        const priceCache = new Map();

        function trackChanges(container) {
            const rows = container.querySelectorAll('tr[data-symbol]');

            rows.forEach(row => {
                const symbol = row.dataset.symbol;

                // Track PnL changes
                const pnlCell = row.querySelector('.pnl-cell');
                if (pnlCell) {
                    const pnlText = pnlCell.querySelector('.pnl-value')?.textContent || '';
                    const currentPnl = parseFloat(pnlText.replace(/[^-\d.]/g, '')) || 0;

                    if (pnlCache.has(symbol)) {
                        const prevPnl = pnlCache.get(symbol);
                        if (currentPnl !== prevPnl) {
                            pnlCell.classList.remove('flash-profit', 'flash-loss');
                            void pnlCell.offsetWidth;
                            pnlCell.classList.add(currentPnl > prevPnl ? 'flash-profit' : 'flash-loss');
                        }
                    }
                    pnlCache.set(symbol, currentPnl);
                }

                // Track Price changes
                const priceCell = row.querySelector('.price-cell');
                if (priceCell) {
                    const priceText = priceCell.querySelector('.price-value')?.textContent || '';
                    const currentPrice = parseFloat(priceText.replace(/[^-\d.]/g, '')) || 0;

                    if (priceCache.has(symbol)) {
                        const prevPrice = priceCache.get(symbol);
                        if (currentPrice !== prevPrice) {
                            priceCell.classList.remove('flash-profit', 'flash-loss');
                            void priceCell.offsetWidth;
                            priceCell.classList.add(currentPrice > prevPrice ? 'flash-profit' : 'flash-loss');
                        }
                    }
                    priceCache.set(symbol, currentPrice);
                }
            });
        }

        // Signal Filtering Logic
        function filterSignals(filter) {
            const items = document.querySelectorAll('.signal-item');
            let hasVisible = false;
            items.forEach(item => {
                const status = item.dataset.status; // RUNNING, WIN, LOSS
                if (filter === 'ALL') {
                    item.style.display = '';
                    hasVisible = true;
                } else {
                    if (status === filter) {
                        item.style.display = '';
                        hasVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }

        // HTMX event listeners
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            // Check if the swap was for positions table
            if (evt.detail.target && evt.detail.target.tagName === 'TBODY') {
                trackChanges(evt.detail.target);
            }
            // Re-apply filter when signal list updates
            if (evt.detail.target.id === 'scan-results') {
                const filter = document.getElementById('signalFilter').value;
                filterSignals(filter);
            }
        });
    </script>
</body>

</html>
{{end}}