{{define "dashboard"}}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NeuroTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- SweetAlert2 for nice alerts instead of native confirm -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'grotesk': ['Space Grotesk', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }

        .neo-btn {
            transition: all 0.1s ease;
        }

        .neo-btn:hover {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .neo-btn:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        .neo-card {
            transition: all 0.1s ease;
        }

        .swal2-container {
            z-index: 9999 !important;
        }
    </style>
</head>

<body class="bg-[#f4f4f0] min-h-screen">
    <!-- Top Navbar (Sticky) -->
    <nav class="sticky top-0 z-50 bg-white border-b-2 border-black shadow-[0px_4px_0px_0px_#000]">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Left: Logo -->
                <div class="flex items-center space-x-4">
                    <div class="bg-black border-2 border-black px-6 py-2 shadow-[4px_4px_0px_0px_#000]">
                        <h1 class="text-2xl font-bold text-white">‚ö° NeuroTrade</h1>
                    </div>
                    <div class="hidden md:block">
                        <p class="text-sm font-medium text-gray-600">Welcome back,</p>
                        <p class="text-lg font-bold text-black">{{.User.Username}}</p>
                    </div>
                </div>

                <!-- Right: Balance, Mode, Logout -->
                <div class="flex items-center space-x-4">
                    <!-- Balance Badge -->
                    <div class="bg-[#d4ff00] border-2 border-black px-6 py-3 shadow-[4px_4px_0px_0px_#000]">
                        <p class="text-xs font-semibold text-black uppercase tracking-wide">Balance</p>
                        <p class="text-2xl font-bold text-black">${{printf "%.2f" .User.PaperBalance}}</p>
                    </div>

                    <!-- Auto-Trade Toggle -->
                    <div
                        class="flex items-center space-x-2 bg-white border-2 border-black px-4 py-3 shadow-[4px_4px_0px_0px_#000]">
                        <span class="text-sm font-bold text-black uppercase">AUTO-TRADE</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="enabled" value="true" class="sr-only peer"
                                hx-post="/api/user/settings/autotrade" hx-swap="none" {{if
                                .User.IsAutoTradeEnabled}}checked{{end}}>
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none border-2 border-black rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-black after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#51cf66]">
                            </div>
                        </label>
                    </div>

                    <!-- Mode Toggle -->
                    <button hx-post="/api/user/mode/toggle" hx-swap="none" class="neo-btn px-6 py-3 border-2 border-black font-bold uppercase tracking-wide shadow-[4px_4px_0px_0px_#000]
                        {{if eq .User.Mode " PAPER"}} bg-[#ffd43b] text-black {{else}} bg-[#51cf66] text-black
                        {{end}}">
                        {{if eq .User.Mode "PAPER"}}üìÑ PAPER{{else}}üí∞ REAL{{end}}
                    </button>

                    <!-- Logout -->
                    <form method="POST" action="/api/auth/logout" onsubmit="confirmLogout(event)">
                        <button type="submit"
                            class="neo-btn px-4 py-3 bg-white border-2 border-black text-black font-semibold shadow-[4px_4px_0px_0px_#000] hover:bg-gray-100">
                            üö™ Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Row 1: Critical Controls -->
        <div class="grid grid-cols-12 gap-6 mb-6">
            <!-- Panic Button (Span 4) - Admin Only -->
            {{if .IsAdmin}}
            <div class="col-span-12 md:col-span-4">
                <div class="neo-card bg-[#ff6b6b] border-2 border-black p-6 shadow-[8px_8px_0px_0px_#000] h-full">
                    <h2 class="text-2xl font-bold text-white mb-4">‚ö†Ô∏è EMERGENCY</h2>
                    <button hx-post="/api/user/panic-button"
                        hx-confirm="üö® DANGER: Are you sure you want to FORCE CLOSE ALL positions immediately? This cannot be undone."
                        hx-target="#panic-response"
                        class="neo-btn w-full bg-black border-2 border-black text-white font-bold py-4 px-6 text-lg shadow-[4px_4px_0px_0px_#fff] hover:shadow-none uppercase tracking-wide">
                        üö® STOP ALL
                    </button>
                    <div id="panic-response" class="mt-4"></div>
                </div>
            </div>
            {{end}}

            <!-- Strategy Config (Span 8) / Dashboard Banner (Span 12 for User) -->
            {{if .IsAdmin}}
            <div class="col-span-12 md:col-span-8">
                <div class="neo-card bg-white border-2 border-black p-6 shadow-[8px_8px_0px_0px_#000] h-full">
                    <h2 class="text-2xl font-bold text-black mb-4">üéØ Strategy Configuration</h2>
                    <form hx-put="/api/admin/strategies/active" hx-target="#strategy-response"
                        hx-confirm="Are you sure you want to change the active strategy?">
                        <!-- ... form content ... -->
                        <label for="strategy" class="block text-sm font-bold text-black uppercase tracking-wide mb-2">
                            Active Strategy Prompt:
                        </label>
                        <select id="strategy" name="preset_id"
                            class="w-full px-4 py-3 bg-white border-2 border-black text-black font-medium shadow-[4px_4px_0px_0px_#000] focus:outline-none focus:ring-0 mb-4">
                            {{range .Strategies}}
                            <option value="{{.ID}}" {{if .IsActive}}selected{{end}}>
                                {{.Name}}
                            </option>
                            {{end}}
                        </select>
                        <button type="submit"
                            class="neo-btn w-full bg-[#4dabf7] border-2 border-black text-black font-bold py-3 px-4 shadow-[4px_4px_0px_0px_#000] uppercase tracking-wide">
                            üíæ Update Strategy
                        </button>
                    </form>
                    <div id="strategy-response" class="mt-4"></div>
                </div>
            </div>
            {{else}}
            <!-- Non-admin: Full width Trading Dashboard Banner -->
            <div class="col-span-12">
                <div
                    class="neo-card bg-[#4dabf7] border-2 border-black p-6 shadow-[8px_8px_0px_0px_#000] h-full flex items-center justify-center">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-black mb-2">üìä Trading Dashboard</h2>
                        <p class="text-lg font-medium text-black">Monitor your positions below</p>
                    </div>
                </div>
            </div>
            {{end}}
        </div>

        <!-- Row 1.5: Pending Approvals (If any) -->
        {{if .PendingPositions}}
        <div class="mb-6">
            <div class="neo-card bg-[#fff9db] border-2 border-black shadow-[8px_8px_0px_0px_#000]">
                <!-- Header -->
                <div class="bg-black border-b-2 border-black px-6 py-4 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">‚è≥ Waiting for Approval</h2>
                    <div class="bg-[#ffd43b] text-black px-3 py-1 font-bold text-sm border border-white">
                        Action Required
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-black text-white border-b-2 border-black">
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Symbol</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Side</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Entry</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Stop Loss</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Take Profit
                                </th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y-2 divide-black">
                            {{range .PendingPositions}}
                            <tr class="hover:bg-[#fff3bf] transition-colors">
                                <td class="py-4 px-6 font-bold text-black">{{.Symbol}}</td>
                                <td class="py-4 px-6">
                                    <span
                                        class="inline-block border-2 border-black px-3 py-1 font-bold text-sm shadow-[2px_2px_0px_0px_#000] {{if eq .Side "
                                        SHORT"}}bg-[#ff6b6b] text-white{{else}}bg-[#51cf66] text-black{{end}}">
                                        {{.Side}}
                                    </span>
                                </td>
                                <td class="py-4 px-6 font-medium text-black">${{printf "%.4f" .EntryPrice}}</td>
                                <td class="py-4 px-6 font-medium text-black">${{printf "%.4f" .SLPrice}}</td>
                                <td class="py-4 px-6 font-medium text-black">${{printf "%.4f" .TPPrice}}</td>
                                <td class="py-4 px-6 flex space-x-2">
                                    <button hx-post="/api/user/positions/{{.ID}}/approve" hx-target="closest tr"
                                        hx-swap="outerHTML"
                                        class="bg-[#51cf66] border-2 border-black text-black font-bold px-4 py-2 shadow-[2px_2px_0px_0px_#000] hover:translate-x-[1px] hover:translate-y-[1px] hover:shadow-none transition-all text-sm uppercase">
                                        ‚úÖ Approve
                                    </button>
                                    <button hx-post="/api/user/positions/{{.ID}}/decline" hx-target="closest tr"
                                        hx-swap="outerHTML" hx-confirm="Decline this signal?"
                                        class="bg-[#ff6b6b] border-2 border-black text-white font-bold px-4 py-2 shadow-[2px_2px_0px_0px_#000] hover:translate-x-[1px] hover:translate-y-[1px] hover:shadow-none transition-all text-sm uppercase">
                                        ‚ùå Decline
                                    </button>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {{end}}

        <!-- Row 2: Active Positions -->
        <div class="mb-6">
            <div class="neo-card bg-white border-2 border-black shadow-[8px_8px_0px_0px_#000]">
                <!-- Header -->
                <div class="bg-black border-b-2 border-black px-6 py-4 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">üìä Active Positions</h2>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-[#51cf66] rounded-full animate-pulse border-2 border-white"></div>
                        <span class="text-sm font-semibold text-white uppercase tracking-wide">Realtime Sync
                            (10s)</span>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-black text-white border-b-2 border-black">
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Symbol</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Side</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Entry</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Current</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Stop Loss</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Take Profit
                                </th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">PnL</th>
                                <th class="py-4 px-6 text-left text-sm font-bold uppercase tracking-wide">Action</th>
                            </tr>
                        </thead>
                        <tbody hx-get="/api/user/positions/html" hx-trigger="load, every 10s" hx-swap="innerHTML"
                            class="divide-y-2 divide-black">
                            <!-- HTMX will load positions here -->
                            <tr>
                                <td colspan="8" class="py-12 text-center">
                                    <div
                                        class="inline-block animate-pulse bg-black text-white px-6 py-3 border-2 border-black font-bold">
                                        Loading positions...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Row 3: KPI Stats (Admin Only) -->
        {{if .IsAdmin}}
        <div class="grid grid-cols-12 gap-6">
            <!-- Total Users -->
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="neo-card bg-white border-2 border-black p-6 shadow-[6px_6px_0px_0px_#000]">
                    <p class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2">Total Users</p>
                    <p class="text-4xl font-bold text-black">{{.Stats.TotalUsers}}</p>
                </div>
            </div>

            <!-- Total Signals -->
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="neo-card bg-white border-2 border-black p-6 shadow-[6px_6px_0px_0px_#000]">
                    <p class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2">Total Signals</p>
                    <p class="text-4xl font-bold text-black">{{.Stats.TotalSignals}}</p>
                </div>
            </div>

            <!-- Active Positions -->
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="neo-card bg-[#ffd43b] border-2 border-black p-6 shadow-[6px_6px_0px_0px_#000]">
                    <p class="text-sm font-bold text-black uppercase tracking-wide mb-2">Active Positions</p>
                    <p class="text-4xl font-bold text-black">{{.Stats.ActivePositions}}</p>
                </div>
            </div>

            <!-- Win Rate -->
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="neo-card bg-[#51cf66] border-2 border-black p-6 shadow-[6px_6px_0px_0px_#000]">
                    <p class="text-sm font-bold text-black uppercase tracking-wide mb-2">Win Rate</p>
                    <p class="text-4xl font-bold text-black">{{printf "%.1f" .Stats.WinRate}}%</p>
                </div>
            </div>
        </div>

        <!-- Admin Controls Row -->
        <div class="grid grid-cols-12 gap-6 mt-6">
            <!-- Market Scan -->
            <div class="col-span-12">
                <div class="neo-card bg-white border-2 border-black p-6 shadow-[6px_6px_0px_0px_#000]">
                    <!-- Header with Trigger Button -->
                    <div class="flex items-center justify-between mb-4 pb-4 border-b-2 border-black">
                        <h3 class="text-xl font-bold text-black">üîÑ Market Scan</h3>
                        <button hx-post="/api/admin/market-scan/trigger" hx-target="#scan-response"
                            hx-confirm="Start a manual market scan? This might take up to a minute."
                            class="neo-btn bg-[#ff6b6b] border-2 border-black text-white font-bold py-2 px-6 shadow-[4px_4px_0px_0px_#000] uppercase tracking-wide text-sm">
                            üöÄ Trigger Now
                        </button>
                    </div>

                    <!-- Trigger Response -->
                    <div id="scan-response" class="mb-4"></div>

                    <!-- Latest Signals -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-bold text-black uppercase tracking-wide">Latest Signals</h4>
                            <span class="text-xs text-gray-600">Auto-refresh 10s</span>
                        </div>
                        <div id="scan-results" hx-get="/api/admin/market-scan/results" hx-trigger="load, every 10s"
                            hx-swap="innerHTML" class="max-h-[300px] overflow-y-auto">
                            <div
                                class="p-3 bg-gray-100 border-2 border-black text-black text-sm font-medium shadow-[2px_2px_0px_0px_#000] animate-pulse">
                                Loading signals...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Mode Section -->
        <div class="grid grid-cols-12 gap-6 mt-6">
            <!-- Trading Mode Switcher -->
            <div class="col-span-12 md:col-span-6">
                <div class="neo-card bg-white border-2 border-black p-6 shadow-[6px_6px_0px_0px_#000]">
                    <h3 class="text-xl font-bold text-black mb-4">üéØ Trading Mode</h3>
                    <form hx-put="/api/admin/trading-mode" hx-target="#mode-response"
                        hx-confirm="Change trading mode? This will affect how the AI analyzes markets.">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <!-- SCALPER Option -->
                            <label class="cursor-pointer">
                                <input type="radio" name="mode" value="SCALPER" class="hidden peer" id="mode-scalper"
                                    {{if eq .TradingMode "SCALPER" }}checked{{end}}>
                                <div
                                    class="peer-checked:bg-[#d4ff00] peer-checked:border-black border-2 border-gray-300 p-4 shadow-[4px_4px_0px_0px_#ccc] peer-checked:shadow-[4px_4px_0px_0px_#000] transition-all">
                                    <div class="text-center">
                                        <p class="text-2xl mb-1">‚ö°</p>
                                        <p class="font-bold text-black uppercase">SCALPER</p>
                                        <p class="text-xs text-gray-600 mt-1">M15 Ping-Pong</p>
                                    </div>
                                </div>
                            </label>
                            <!-- INVESTOR Option -->
                            <label class="cursor-pointer">
                                <input type="radio" name="mode" value="INVESTOR" class="hidden peer" id="mode-investor"
                                    {{if eq .TradingMode "INVESTOR" }}checked{{end}}>
                                <div
                                    class="peer-checked:bg-[#4dabf7] peer-checked:border-black border-2 border-gray-300 p-4 shadow-[4px_4px_0px_0px_#ccc] peer-checked:shadow-[4px_4px_0px_0px_#000] transition-all">
                                    <div class="text-center">
                                        <p class="text-2xl mb-1">üìà</p>
                                        <p class="font-bold text-black uppercase">INVESTOR</p>
                                        <p class="text-xs text-gray-600 mt-1">H1 Trend Following</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <button type="submit"
                            class="neo-btn w-full bg-black border-2 border-black text-white font-bold py-3 px-4 shadow-[4px_4px_0px_0px_#666] uppercase tracking-wide">
                            üíæ Save Mode
                        </button>
                    </form>
                    <div id="mode-response" class="mt-4"></div>
                </div>
            </div>
        </div>
        {{end}}
    </div>

    <script>
        // Handle successful mode toggle
        document.body.addEventListener('htmx:afterRequest', function (event) {
            if (event.detail.pathInfo.requestPath === '/api/user/mode/toggle' && event.detail.successful) {
                window.location.reload();
            }
        });

        // Intercept htmx:confirm to use SweetAlert2
        document.body.addEventListener('htmx:confirm', function (evt) {
            if (!evt.detail.question) return; // If no confirmation text, let it proceed naturally

            evt.preventDefault();
            Swal.fire({
                title: 'Are you sure?',
                text: evt.detail.question,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#000000', // Black for neo-brutalism
                cancelButtonColor: '#ff6b6b',  // Red for cancel
                confirmButtonText: 'Yes, proceed!',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'border-2 border-black shadow-[8px_8px_0px_0px_#000] rounded-none',
                    confirmButton: 'border-2 border-black shadow-[4px_4px_0px_0px_#000] rounded-none px-6 py-2 font-bold uppercase hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all',
                    cancelButton: 'border-2 border-black shadow-[4px_4px_0px_0px_#000] rounded-none px-6 py-2 font-bold uppercase hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    evt.detail.issueRequest(true); // Proceed with the request
                }
            });
        });

        // Handle Logout Form separately (since it's not HTMX)
        function confirmLogout(event) {
            event.preventDefault();
            Swal.fire({
                title: 'Logout?',
                text: "Are you sure you want to logout?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#000000',
                cancelButtonColor: '#ff6b6b',
                confirmButtonText: 'Yes, Logout',
                customClass: {
                    popup: 'border-2 border-black shadow-[8px_8px_0px_0px_#000] rounded-none',
                    confirmButton: 'border-2 border-black shadow-[4px_4px_0px_0px_#000] rounded-none px-6 py-2 font-bold uppercase hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all',
                    cancelButton: 'border-2 border-black shadow-[4px_4px_0px_0px_#000] rounded-none px-6 py-2 font-bold uppercase hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    event.target.submit();
                }
            });
        }
    </script>
</body>

</html>
{{end}}