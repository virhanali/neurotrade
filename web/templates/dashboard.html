{{define "dashboard"}}
<!DOCTYPE html>
<html lang="en" class="light">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroTrade | AI Quantitative System</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="apple-touch-icon" href="/static/images/favicon.svg">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config for Dark Mode & Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark surface
                            900: '#0f172a',
                            950: '#020617', // Custom dark bg
                        }
                    }
                }
            }
        }
    </script>

    <!-- Dark Mode Logic -->
    <script>
        // Check local storage or system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* HTMX Indicator - Skeleton styles */
        .htmx-indicator {
            display: none;
            opacity: 0;
            transition: opacity 200ms ease-in;
        }

        .htmx-request .htmx-indicator {
            display: inline;
            opacity: 1;
        }

        .htmx-request.htmx-indicator {
            display: inline;
            opacity: 1;
        }

        /* Skeleton Animation */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* PnL Flash Animation */
        @keyframes flash-green {
            0% {
                background-color: rgba(16, 185, 129, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes flash-red {
            0% {
                background-color: rgba(244, 63, 94, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        .flash-profit {
            animation: flash-green 0.6s ease-out;
        }

        .flash-loss {
            animation: flash-red 0.6s ease-out;
        }

        .pnl-cell,
        .price-cell {
            transition: all 0.2s ease;
            border-radius: 0.375rem;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-200">

    <!-- Mobile Header -->
    <div
        class="lg:hidden flex items-center justify-between p-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
            <i class="ri-brain-line text-emerald-500 text-xl"></i>
            <span class="font-bold text-lg">NeuroTrade</span>
        </div>
        <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')"
            class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
            <i class="ri-menu-line text-xl"></i>
        </button>
    </div>

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar Navigation -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-auto transition-transform duration-300 flex flex-col">
            <!-- Brand -->
            <div class="h-16 flex items-center px-6 border-b border-slate-100 dark:border-slate-800">
                <i class="ri-brain-fill text-emerald-500 text-2xl mr-2"></i>
                <span class="font-bold text-xl tracking-tight">NeuroTrade <span
                        class="text-xs text-slate-400 font-normal">v2.5</span></span>
            </div>

            <!-- Nav Links -->
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <a href="#"
                    class="flex items-center px-3 py-2.5 bg-slate-100 dark:bg-slate-800 text-emerald-600 dark:text-emerald-400 font-medium rounded-lg group">
                    <i class="ri-dashboard-3-line mr-3 text-lg"></i>
                    Dashboard
                </a>
                <a href="#"
                    class="flex items-center px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-100 font-medium rounded-lg transition-colors group">
                    <i class="ri-pulse-line mr-3 text-lg group-hover:text-emerald-500"></i>
                    Live Positions
                </a>
                <a href="#"
                    class="flex items-center px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-100 font-medium rounded-lg transition-colors group">
                    <i class="ri-history-line mr-3 text-lg group-hover:text-emerald-500"></i>
                    Trade History
                </a>
                <!-- Settings Removed -->
            </nav>

            <!-- User Profile & Theme -->
            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Appearance</span>
                    <button onclick="toggleTheme()"
                        class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 transition-colors">
                        <i class="ri-sun-line dark:hidden"></i>
                        <i class="ri-moon-line hidden dark:inline"></i>
                    </button>
                </div>
                <div
                    class="flex items-center p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700">
                    <div
                        class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900 flex items-center justify-center text-emerald-600 dark:text-emerald-400 font-bold text-sm">
                        {{if .User.Username}}{{slice .User.Username 0 1}}{{else}}A{{end}}
                    </div>
                    <div class="ml-3 overflow-hidden flex-1">
                        <p class="text-sm font-medium text-slate-900 dark:text-white truncate">{{.User.Username}}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 capitalize">{{.User.Role}}</p>
                    </div>
                </div>
                <!-- Logout Button -->
                <form id="logout-form" action="/api/auth/logout" method="POST" class="hidden"></form>
                <button
                    onclick="showConfirmModal('Logout', 'Are you sure you want to end your session?', () => document.getElementById('logout-form').submit(), 'logout')"
                    class="mt-3 w-full flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-rose-600 dark:hover:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors">
                    <i class="ri-logout-box-r-line"></i>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto h-full relative" id="main-content">
            <!-- Toast Container -->
            <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

                <!-- Page Header & Actions -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Market Overview</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Aggressive Scalping â€¢ M15 Timeframe
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button
                            onclick="showConfirmModal('Trigger Market Scan?', 'This will analyze top coins and generate trading signals based on AI analysis.', () => { htmx.ajax('POST', '/api/admin/market-scan/trigger', {target:'#scan-results', swap:'innerHTML'}); showToast('Market scan triggered!'); })"
                            class="inline-flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg shadow-sm transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                            <i class="ri-radar-line mr-2"></i>
                            Scan Now
                        </button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">

                    <!-- Balance Card -->
                    <div
                        class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden group hover:border-emerald-500/30 transition-colors">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Equity</p>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1">${{printf "%.2f"
                                    .User.PaperBalance}}</h3>
                                {{if gt .TodayPnLPercent 0.0}}
                                <div
                                    class="flex items-center mt-1 text-xs text-emerald-600 dark:text-emerald-400 font-medium">
                                    <i class="ri-arrow-up-line mr-1"></i>
                                    <span>+{{printf "%.2f" .TodayPnLPercent}}% Today</span>
                                </div>
                                {{else if lt .TodayPnLPercent 0.0}}
                                <div
                                    class="flex items-center mt-1 text-xs text-rose-600 dark:text-rose-400 font-medium">
                                    <i class="ri-arrow-down-line mr-1"></i>
                                    <span>{{printf "%.2f" .TodayPnLPercent}}% Today</span>
                                </div>
                                {{else}}
                                <div
                                    class="flex items-center mt-1 text-xs text-slate-500 dark:text-slate-400 font-medium">
                                    <i class="ri-subtract-line mr-1"></i>
                                    <span>0.00% Today</span>
                                </div>
                                {{end}}
                            </div>
                            <div
                                class="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400 group-hover:text-emerald-500 transition-colors">
                                <i class="ri-wallet-3-line text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- PnL Card -->
                    <div
                        class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total PnL</p>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="total-pnl">
                                    {{if .Stats}}{{if index .Stats "total_pnl"}}${{printf "%.2f" (index .Stats
                                    "total_pnl")}}{{else}}$0.00{{end}}{{else}}$0.00{{end}}</h3>
                            </div>
                            <div
                                class="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400">
                                <i class="ri-line-chart-line text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Win Rate Card -->
                    <div
                        class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Win Rate</p>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1">{{if .Stats}}{{printf
                                    "%.1f" .Stats.WinRate}}%{{else}}--%{{end}}</h3>
                            </div>
                            <div
                                class="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400">
                                <i class="ri-trophy-line text-xl"></i>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- Main Content Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                    <!-- Left Column: Activity & Chart (2/3) -->
                    <div class="lg:col-span-2 space-y-8">

                        <!-- Empty State / Chart Placeholder -->
                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Performance Analytics
                                </h3>
                                <select
                                    class="bg-slate-50 dark:bg-slate-800 border-none text-xs rounded-md text-slate-600 dark:text-slate-300 py-1 pl-2 pr-6">
                                    <option>Last 24 Hours</option>
                                    <option>Last 7 Days</option>
                                </select>
                            </div>
                            <div id="chart-container" class="h-64 relative w-full">
                                <!-- Canvas for Chart.js -->
                                <canvas id="performanceChart"></canvas>
                            </div>

                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    const ctx = document.getElementById('performanceChart').getContext('2d');

                                    // Fetch PnL History
                                    fetch('/api/user/analytics/pnl')
                                        .then(response => response.json())
                                        .then(res => {
                                            if (res.data && res.data.labels && res.data.labels.length > 0) {
                                                const isDark = document.documentElement.classList.contains('dark');
                                                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                                                const textColor = isDark ? '#94a3b8' : '#64748b';

                                                new Chart(ctx, {
                                                    type: 'line',
                                                    data: {
                                                        labels: res.data.labels,
                                                        datasets: [{
                                                            label: 'Cumulative PnL',
                                                            data: res.data.data,
                                                            borderColor: '#10b981', // Emerald 500
                                                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                                            borderWidth: 2,
                                                            tension: 0.4, // Smooth curve
                                                            fill: true,
                                                            pointRadius: 3,
                                                            pointHoverRadius: 5,
                                                            pointBackgroundColor: '#10b981'
                                                        }]
                                                    },
                                                    options: {
                                                        responsive: true,
                                                        maintainAspectRatio: false,
                                                        plugins: {
                                                            legend: { display: false },
                                                            tooltip: {
                                                                mode: 'index',
                                                                intersect: false,
                                                                backgroundColor: isDark ? '#1e293b' : '#ffffff',
                                                                titleColor: isDark ? '#ffffff' : '#0f172a',
                                                                bodyColor: isDark ? '#cbd5e1' : '#334155',
                                                                borderColor: isDark ? '#334155' : '#e2e8f0',
                                                                borderWidth: 1,
                                                                callbacks: {
                                                                    label: function (context) {
                                                                        return ' PnL: $' + context.parsed.y.toFixed(2);
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        scales: {
                                                            x: {
                                                                display: false, // Hide numeric labels for cleaner look
                                                                grid: { display: false }
                                                            },
                                                            y: {
                                                                grid: { color: gridColor },
                                                                ticks: {
                                                                    color: textColor,
                                                                    callback: function (value) { return '$' + value; },
                                                                    font: { family: "'Inter', sans-serif", size: 10 }
                                                                },
                                                                border: { display: false }
                                                            }
                                                        },
                                                        interaction: {
                                                            mode: 'nearest',
                                                            axis: 'x',
                                                            intersect: false
                                                        }
                                                    }
                                                });
                                            } else {
                                                // Show Empty State if no data
                                                document.getElementById('chart-container').innerHTML = `
                                                    <div class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 bg-slate-50/50 dark:bg-slate-800/20 rounded-lg border border-dashed border-slate-200 dark:border-slate-700">
                                                        <i class="ri-bar-chart-groupped-line text-4xl mb-2 opacity-50"></i>
                                                        <p class="text-sm font-medium">Chart data will appear after first close trade</p>
                                                    </div>
                                                `;
                                            }
                                        })
                                        .catch(err => console.error("Failed to load chart data:", err));
                                });
                            </script>
                        </div>

                        <!-- Active Positions Table -->
                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div
                                class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Active Positions</h3>
                                <span
                                    class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-xs px-2 py-1 rounded-full font-medium">Live</span>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full text-left">
                                    <thead
                                        class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800">
                                        <tr>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                Symbol</th>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                Side</th>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                Entry</th>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                Current</th>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                TP/SL</th>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                                PnL</th>
                                            <th
                                                class="py-3 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">
                                                Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-800"
                                        hx-get="/api/user/positions/html" hx-trigger="load, every 5s">
                                        <!-- Loading State inside Table -->
                                        <tr>
                                            <td colspan="7" class="p-4 text-center text-sm text-slate-400">
                                                <div class="flex items-center justify-center gap-2">
                                                    <i class="ri-loader-4-line animate-spin"></i> Loading positions...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Signals & Feed (1/3) -->
                    <div class="space-y-8">

                        <!-- Latest Signals -->
                        <div
                            class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col max-h-[600px]">
                            <div
                                class="px-5 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-900 z-10">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">AI Signals</h3>
                                    <span class="flex h-2 w-2 relative">
                                        <span
                                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                    </span>
                                </div>
                                <select id="signalFilter" onchange="filterSignals(this.value)"
                                    class="bg-slate-50 dark:bg-slate-800 border-none text-[10px] font-medium uppercase tracking-wide rounded text-slate-600 dark:text-slate-400 py-1 pl-2 pr-6 focus:ring-0 cursor-pointer h-7">
                                    <option value="ALL">All</option>
                                    <option value="RUNNING">Running</option>
                                    <option value="WIN">Wins</option>
                                    <option value="LOSS">Losses</option>
                                </select>
                            </div>

                            <!-- CONTENT AREA -->
                            <div id="scan-results" class="overflow-y-auto p-2 space-y-2 flex-1 custom-scrollbar"
                                hx-get="/api/admin/market-scan/results" hx-trigger="load, every 10s">

                                <!-- SKELETON -->
                                <div
                                    class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                                    <div class="flex justify-between mb-2">
                                        <div class="skeleton h-4 w-20 rounded"></div>
                                        <div class="skeleton h-4 w-12 rounded"></div>
                                    </div>
                                    <div class="skeleton h-3 w-full rounded"></div>
                                </div>
                                <div
                                    class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                                    <div class="flex justify-between mb-2">
                                        <div class="skeleton h-4 w-20 rounded"></div>
                                        <div class="skeleton h-4 w-12 rounded"></div>
                                    </div>
                                    <div class="skeleton h-3 w-full rounded"></div>
                                </div>
                            </div>
                        </div>

                        <!-- System Status Small -->
                        <div
                            class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                            <h4
                                class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">
                                System Health</h4>
                            <div hx-get="/api/admin/system/health" hx-trigger="load, every 30s">
                                <div class="skeleton h-4 w-full rounded"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="hideConfirmModal()"></div>
        <!-- Modal -->
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 w-full max-w-sm transform transition-all scale-95 opacity-0"
                id="confirm-modal-content">
                <div class="p-6">
                    <!-- Icon -->
                    <div id="confirm-modal-icon"
                        class="w-12 h-12 mx-auto mb-4 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                        <i class="ri-question-line text-2xl text-emerald-600 dark:text-emerald-400"></i>
                    </div>
                    <!-- Title -->
                    <h3 id="confirm-modal-title"
                        class="text-lg font-semibold text-slate-900 dark:text-white text-center mb-2">
                        Confirm Action
                    </h3>
                    <!-- Message -->
                    <p id="confirm-modal-message" class="text-sm text-slate-500 dark:text-slate-400 text-center">
                        Are you sure you want to proceed?
                    </p>
                </div>
                <!-- Actions -->
                <div class="flex border-t border-slate-200 dark:border-slate-700">
                    <button onclick="hideConfirmModal()"
                        class="flex-1 py-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors rounded-bl-2xl">
                        Cancel
                    </button>
                    <button id="confirm-modal-btn" onclick="confirmModalAction()"
                        class="flex-1 py-3 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 transition-colors rounded-br-2xl">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Confirmation Modal State
        let confirmCallback = null;

        function showConfirmModal(title, message, callback, type = 'default') {
            confirmCallback = callback;

            // Set content
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;

            // Set icon and button color based on type
            const iconEl = document.getElementById('confirm-modal-icon');
            const btnEl = document.getElementById('confirm-modal-btn');

            if (type === 'logout' || type === 'danger') {
                iconEl.className = 'w-12 h-12 mx-auto mb-4 rounded-full bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center';
                iconEl.innerHTML = '<i class="ri-logout-box-r-line text-2xl text-rose-600 dark:text-rose-400"></i>';
                btnEl.className = 'flex-1 py-3 text-sm font-semibold text-white bg-rose-600 hover:bg-rose-700 transition-colors rounded-br-2xl';
                btnEl.textContent = type === 'logout' ? 'Logout' : 'Confirm';
            } else {
                iconEl.className = 'w-12 h-12 mx-auto mb-4 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center';
                iconEl.innerHTML = '<i class="ri-radar-line text-2xl text-emerald-600 dark:text-emerald-400"></i>';
                btnEl.className = 'flex-1 py-3 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 transition-colors rounded-br-2xl';
                btnEl.textContent = 'Confirm';
            }

            // Show modal
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.classList.remove('hidden');

            // Animate in
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            });
        }

        function hideConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
                confirmCallback = null;
            }, 150);
        }

        function confirmModalAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmModal();
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let bgClass = type === 'success' ? 'bg-slate-900 dark:bg-slate-800 text-white' : 'bg-rose-600 text-white';
            let icon = type === 'success' ? '<i class="ri-checkbox-circle-fill text-emerald-400 text-lg"></i>' : '<i class="ri-error-warning-fill text-white text-lg"></i>';

            toast.className = `flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-2 opacity-0 ${bgClass}`;
            toast.innerHTML = `
                ${icon}
                <span class="text-sm font-medium">${message}</span>
            `;

            container.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Price & PnL Flash Tracking
        const pnlCache = new Map();
        const priceCache = new Map();

        function trackChanges(container) {
            const rows = container.querySelectorAll('tr[data-symbol]');

            rows.forEach(row => {
                const symbol = row.dataset.symbol;

                // Track PnL changes
                const pnlCell = row.querySelector('.pnl-cell');
                if (pnlCell) {
                    const pnlText = pnlCell.querySelector('.pnl-value')?.textContent || '';
                    const currentPnl = parseFloat(pnlText.replace(/[^-\d.]/g, '')) || 0;

                    if (pnlCache.has(symbol)) {
                        const prevPnl = pnlCache.get(symbol);
                        if (currentPnl !== prevPnl) {
                            pnlCell.classList.remove('flash-profit', 'flash-loss');
                            void pnlCell.offsetWidth;
                            pnlCell.classList.add(currentPnl > prevPnl ? 'flash-profit' : 'flash-loss');
                        }
                    }
                    pnlCache.set(symbol, currentPnl);
                }

                // Track Price changes
                const priceCell = row.querySelector('.price-cell');
                if (priceCell) {
                    const priceText = priceCell.querySelector('.price-value')?.textContent || '';
                    const currentPrice = parseFloat(priceText.replace(/[^-\d.]/g, '')) || 0;

                    if (priceCache.has(symbol)) {
                        const prevPrice = priceCache.get(symbol);
                        if (currentPrice !== prevPrice) {
                            priceCell.classList.remove('flash-profit', 'flash-loss');
                            void priceCell.offsetWidth;
                            priceCell.classList.add(currentPrice > prevPrice ? 'flash-profit' : 'flash-loss');
                        }
                    }
                    priceCache.set(symbol, currentPrice);
                }
            });
        }

        // Signal Filtering Logic
        function filterSignals(filter) {
            const items = document.querySelectorAll('.signal-item');
            let hasVisible = false;
            items.forEach(item => {
                const status = item.dataset.status; // RUNNING, WIN, LOSS
                if (filter === 'ALL') {
                    item.style.display = '';
                    hasVisible = true;
                } else {
                    if (status === filter) {
                        item.style.display = '';
                        hasVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }

        // HTMX event listeners
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            // Check if the swap was for positions table
            if (evt.detail.target && evt.detail.target.tagName === 'TBODY') {
                trackChanges(evt.detail.target);
            }
            // Re-apply filter when signal list updates
            if (evt.detail.target.id === 'scan-results') {
                const filter = document.getElementById('signalFilter').value;
                filterSignals(filter);
            }
        });
    </script>
</body>

</html>
{{end}}